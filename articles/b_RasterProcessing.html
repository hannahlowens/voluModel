<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2. Processing Raster Data • voluModel</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="2. Processing Raster Data">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">voluModel</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/a_Introduction.html">1. Introduction to `voluModel`</a>
    </li>
    <li>
      <a href="../articles/b_RasterProcessing.html">2. Processing Raster Data</a>
    </li>
    <li>
      <a href="../articles/c_DataSampling.html">3. Environmental Data Sampling</a>
    </li>
    <li>
      <a href="../articles/d_Visualization.html">4. Visualization Tools</a>
    </li>
    <li>
      <a href="../articles/e_GLMWorkflow.html">5. 3D Niche Modeling with the GLM Algorithm</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hannahlowens/voluModel/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>2. Processing Raster Data</h1>
                        <h4 data-toc-skip class="author">Hannah L.
Owens</h4>
                        <h4 data-toc-skip class="author">Carsten
Rahbek</h4>
            
            <h4 data-toc-skip class="date">2025-07-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hannahlowens/voluModel/blob/main/vignettes/b_RasterProcessing.Rmd" class="external-link"><code>vignettes/b_RasterProcessing.Rmd</code></a></small>
      <div class="hidden name"><code>b_RasterProcessing.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Naturally, to build 3D distribution models, one needs
three-dimensionally structured environmental data. These data may come
in the form of interpolated <em>in situ</em> measurements (e.g. <a href="https://www.ncei.noaa.gov/access/world-ocean-atlas-2018/" class="external-link">NOAA’s
World Ocean Atlas dataset</a>; Garcia et al. 2018a) or as outputs from
climate models, either as stand-alone ocean components or as a component
of coupled atmosphere-ocean models (e.g. CCSM3, Collins et al. 2006;
HadCM3, Valdes et al. 2017). Typically, these data are organized as a
series of horizontal layers that are stacked by depth.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hannahlowens.github.io/voluModel/" class="external-link">voluModel</a></span><span class="op">)</span> <span class="co"># Since this is the package this vignette is about.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span> <span class="co"># For data organization</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span> <span class="co"># For supplementary visualization</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dnychka/fieldsRPackage" class="external-link">fields</a></span><span class="op">)</span> <span class="co"># For raster interpolation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span> <span class="co"># Now being transitioned in</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-inputs">Data Inputs<a class="anchor" aria-label="anchor" href="#data-inputs"></a>
</h2>
<p>First, let’s look at a relatively simple environmental variable from
the WOA: temperature (Locarnini et al, 2018). These data are supplied by
the World Ocean Atlas as point shapefiles; the version supplied here has
been cropped between -98 and -45 longitude, between -1 and 45 latitude,
and between 0 and 4,400 m in depth to make it more space-efficientf. You
can download the full dataset via the WOA website. Our first task is to
read in the shapefile as a <code>SpatVector</code>. Note that each row
in <code>temperature</code> is a set of horizontal coordinates. Each
column is a vertical position in the water column. Make sure to check
the metadata of the data you use. Different sources may use vertical
depth structures.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Temperature</span></span>
<span><span class="va">td</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/unzip.html" class="external-link">unzip</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/woa18_decav_t00mn01_cropped.zip"</span>, </span>
<span>                  package <span class="op">=</span> <span class="st">"voluModel"</span><span class="op">)</span>,</span>
<span>      exdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">td</span>, <span class="st">"/temperature"</span><span class="op">)</span>, junkpaths <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">temperature</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">td</span>, <span class="st">"/temperature/woa18_decav_t00mn01_cropped.shp"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Looking at the dataset</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">temperature</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   SURFACE    d5M   d10M   d15M   d20M   d25M   d30M   d35M   d40M   d45M</span></span>
<span><span class="co">## 1  23.575 23.392 22.919 22.318 21.766 21.117 20.531 19.860 19.266 18.673</span></span>
<span><span class="co">## 2  23.204 22.979 22.559 22.057 21.401 20.651 19.978 19.433 18.835 18.247</span></span>
<span><span class="co">## 3  23.451 23.125 22.726 22.134 21.520 20.828 20.128 19.472 18.875 18.353</span></span>
<span><span class="co">## 4  23.261 22.968 22.559 22.052 21.528 20.945 20.337 19.759 19.198 18.669</span></span>
<span><span class="co">## 5  22.977 22.790 22.463 22.036 21.611 21.079 20.521 20.000 19.423 18.835</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plotting the dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html" class="external-link">layout</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">2</span>, byrow<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, widths<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">land</span> <span class="op">&lt;-</span> <span class="fu">rnaturalearth</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html" class="external-link">ne_countries</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="st">"small"</span>, </span>
<span>                                    returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">temperatureForPlot</span> <span class="op">&lt;-</span> <span class="va">temperature</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">temperatureForPlot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">land</span><span class="op">)</span> </span>
<span><span class="va">ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">temperatureForPlot</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">temperatureForPlot</span>, main <span class="op">=</span> <span class="st">"Distribution of voluModel Subset\nof WOA Temperature 2018"</span>,</span>
<span>     pch <span class="op">=</span> <span class="fl">20</span>, col <span class="op">=</span> <span class="st">"red"</span>, xlim <span class="op">=</span> <span class="va">ext</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, ylim <span class="op">=</span> <span class="va">ext</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, cex <span class="op">=</span> <span class="fl">.6</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">land</span>, col <span class="op">=</span> <span class="st">"black"</span>, add <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># What does the WOA depth structure look like?</span></span>
<span><span class="va">depths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">temperatureForPlot</span><span class="op">)</span></span>
<span><span class="va">depths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="va">depths</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, pattern <span class="op">=</span> <span class="st">"[d,M]"</span>, replacement <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">0</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">depths</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>, axes<span class="op">=</span><span class="cn">FALSE</span>, type <span class="op">=</span> <span class="st">"n"</span>, xlab <span class="op">=</span> <span class="st">""</span>, ylab <span class="op">=</span> <span class="st">"Depth Intervals (m)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span>, at <span class="op">=</span> <span class="fl">0</span><span class="op">-</span><span class="va">depths</span>, labels <span class="op">=</span> <span class="va">depths</span><span class="op">)</span></span></code></pre></div>
<p><img src="b_RasterProcessing_files/figure-html/environmental%20data%20loading%20temperature-1.png"><!-- --></p>
<p>Next, we convert temperature into a <code>SpatRaster</code>. While we
are at it, we will generate a raster from the deepest value available
for each point. While you might call this a “bottom” raster, it is
important to note that in some cases, values are not available for the
bottom. After the <code>SpatRaster</code> is created, we give it the
same depth names as the columns in the <code>SpatVector</code>. This is
important, because <code>voluModel</code> uses these names as z
coordinates when handling 3D data. I am using
<code><a href="../reference/oneRasterPlot.html">oneRasterPlot()</a></code> from voluModel to visualize the rasters
using a uniform, high-contrast aesthetic.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Creating a bottom raster</span></span>
<span><span class="va">temperatureBottom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bottomRaster.html">bottomRaster</a></span><span class="op">(</span><span class="va">temperature</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Creating a SpatRaster vector</span></span>
<span><span class="va">template</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/centerPointRasterTemplate.html">centerPointRasterTemplate</a></span><span class="op">(</span><span class="va">temperature</span><span class="op">)</span></span>
<span><span class="va">tempTerVal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">temperature</span>, y <span class="op">=</span> <span class="va">template</span>, field <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">temperature</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get names of depths</span></span>
<span><span class="va">envtNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"[d,M]"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">temperature</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">envtNames</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"0"</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tempTerVal</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">envtNames</span></span>
<span><span class="va">temperature</span> <span class="op">&lt;-</span> <span class="va">tempTerVal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">tempTerVal</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># How do these files look?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oneRasterPlot.html">oneRasterPlot</a></span><span class="op">(</span><span class="va">temperature</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, land <span class="op">=</span> <span class="va">land</span>, landCol <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>              title<span class="op">=</span> <span class="st">"Surface Temperature (C)"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oneRasterPlot.html">oneRasterPlot</a></span><span class="op">(</span><span class="va">temperatureBottom</span>,land <span class="op">=</span> <span class="va">land</span>, landCol <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>              title <span class="op">=</span> <span class="st">"Bottom Temperature (C)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="b_RasterProcessing_files/figure-html/temperature%20processing-1.png"><!-- --></p>
</div>
<div class="section level2">
<h2 id="interpolation">Interpolation<a class="anchor" aria-label="anchor" href="#interpolation"></a>
</h2>
<p>Next, we have a bit of a more complicated example: apparent oxygen
utilization (AOU; Garcia et al, 2018b). Apparent oxygen usage is more
patchily sampled than temperature (it’s generally measured from
instrument casts on research cruises, and the coverage isn’t quite as
dense as for temperature).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">td</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/unzip.html" class="external-link">unzip</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/woa18_all_A00mn01_cropped.zip"</span>, </span>
<span>                  package <span class="op">=</span> <span class="st">"voluModel"</span><span class="op">)</span>,</span>
<span>      exdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">td</span>, <span class="st">"/oxygen"</span><span class="op">)</span>, junkpaths <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="va">oxygen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">td</span>, <span class="st">"/oxygen/woa18_all_A00mn01_cropped.shp"</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">oxygen</span>, main <span class="op">=</span> <span class="st">"Distribution of voluModel subset of WOA AOU 2018"</span>,</span>
<span>     pch <span class="op">=</span> <span class="fl">20</span>, col <span class="op">=</span> <span class="st">"red"</span>, xlim <span class="op">=</span> <span class="va">ext</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, ylim <span class="op">=</span> <span class="va">ext</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, cex <span class="op">=</span> <span class="fl">.6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">land</span>, col <span class="op">=</span> <span class="st">"black"</span>, add <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="b_RasterProcessing_files/figure-html/environmental%20data%20loading%20oxygen-1.png"><!-- --></p>
<p>There is a workaround for this, since we can reasonably expect some
degree of spatial autocorrelation in apparent oxygen utilization. We use
the <code><a href="../reference/interpolateRaster.html">interpolateRaster()</a></code> function to produce
statistically-interpolated layers using <code>TPS()</code> from the
<code>fields</code> package (this is a thin-plate spline interpolation).
Be patient–this step can take a while, although as shown here, I am
using the <code>fastTPS()</code> approximation, which only samples from
nearby cells to speed things up. Maybe <code>fastTPS()</code> will work
ok for your data, maybe it won’t. It depends on the data. For the sake
of efficiency for this example, I am going to limit this to the first 10
depth layers.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Creating a SpatRaster vector for the first 10 depth layers</span></span>
<span><span class="va">oxygen</span> <span class="op">&lt;-</span> <span class="va">oxygen</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span> <span class="co"># Remove this line if you want to process the whole file</span></span>
<span><span class="va">oxygen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">oxygen</span>, y <span class="op">=</span> <span class="va">template</span>,</span>
<span>                   field <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">oxygen</span><span class="op">)</span><span class="op">)</span> <span class="co">#Uses same raster template as temperature</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">oxygen</span><span class="op">)</span><span class="op">)</span><span class="op">{</span> </span>
<span>  <span class="va">oxygen</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/interpolateRaster.html">interpolateRaster</a></span><span class="op">(</span><span class="va">oxygen</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, lon.lat <span class="op">=</span> <span class="cn">T</span>, fast <span class="op">=</span> <span class="cn">T</span>, aRange <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="co">#Thin plate spline interpolation</span></span>
<span>  <span class="va">oxygen</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">oxygen</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, </span>
<span>                           mask <span class="op">=</span> <span class="va">temperature</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                      <span class="va">temperature</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: </span></span>
<span><span class="co">## Grid searches over lambda (nugget and sill variances) with  minima at the endpoints: </span></span>
<span><span class="co">##   (GCV) Generalized Cross-Validation </span></span>
<span><span class="co">##    minimum at  right endpoint  lambda  =  0.06197414 (eff. df= 127.3 )</span></span>
<span><span class="co">## Warning: </span></span>
<span><span class="co">## Grid searches over lambda (nugget and sill variances) with  minima at the endpoints: </span></span>
<span><span class="co">##   (GCV) Generalized Cross-Validation </span></span>
<span><span class="co">##    minimum at  right endpoint  lambda  =  0.06197414 (eff. df= 127.3 )</span></span>
<span><span class="co">## Warning: </span></span>
<span><span class="co">## Grid searches over lambda (nugget and sill variances) with  minima at the endpoints: </span></span>
<span><span class="co">##   (GCV) Generalized Cross-Validation </span></span>
<span><span class="co">##    minimum at  right endpoint  lambda  =  0.06197414 (eff. df= 127.3 )</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Change names to match tempT</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">oxygen</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">envtNames</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">oxygen</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Some environmental data rasters may also look “patchy”, possibly as
an artifact of uneven sampling. If you are confident that there should
be a strong spatial correlation in a data layer that looks “patchy”, you
can also statistically smooth it, again using <code>TPS()</code>, like
this:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Smoothing tempO and saving</span></span>
<span><span class="va">oxygenSmooth</span> <span class="op">&lt;-</span> <span class="va">oxygen</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">oxygenSmooth</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">oxygenSmooth</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smoothRaster.html">smoothRaster</a></span><span class="op">(</span><span class="va">oxygenSmooth</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, lon.lat <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="co">#Thin plate spline interpolation</span></span>
<span>  <span class="va">oxygenSmooth</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">oxygenSmooth</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, mask <span class="op">=</span> <span class="va">temperature</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="va">temperature</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: </span></span>
<span><span class="co">## Grid searches over lambda (nugget and sill variances) with  minima at the endpoints: </span></span>
<span><span class="co">##   (GCV) Generalized Cross-Validation </span></span>
<span><span class="co">##    minimum at  right endpoint  lambda  =  0.06197414 (eff. df= 127.3 )</span></span>
<span><span class="co">## Warning: </span></span>
<span><span class="co">## Grid searches over lambda (nugget and sill variances) with  minima at the endpoints: </span></span>
<span><span class="co">##   (GCV) Generalized Cross-Validation </span></span>
<span><span class="co">##    minimum at  right endpoint  lambda  =  0.06197414 (eff. df= 127.3 )</span></span>
<span><span class="co">## Warning: </span></span>
<span><span class="co">## Grid searches over lambda (nugget and sill variances) with  minima at the endpoints: </span></span>
<span><span class="co">##   (GCV) Generalized Cross-Validation </span></span>
<span><span class="co">##    minimum at  right endpoint  lambda  =  0.06197414 (eff. df= 127.3 )</span></span>
<span><span class="co">## Warning: </span></span>
<span><span class="co">## Grid searches over lambda (nugget and sill variances) with  minima at the endpoints: </span></span>
<span><span class="co">##   (GCV) Generalized Cross-Validation </span></span>
<span><span class="co">##    minimum at  right endpoint  lambda  =  0.06197414 (eff. df= 127.3 )</span></span>
<span><span class="co">## Warning: </span></span>
<span><span class="co">## Grid searches over lambda (nugget and sill variances) with  minima at the endpoints: </span></span>
<span><span class="co">##   (GCV) Generalized Cross-Validation </span></span>
<span><span class="co">##    minimum at  right endpoint  lambda  =  0.06203537 (eff. df= 126.3499 )</span></span>
<span><span class="co">## Warning: </span></span>
<span><span class="co">## Grid searches over lambda (nugget and sill variances) with  minima at the endpoints: </span></span>
<span><span class="co">##   (GCV) Generalized Cross-Validation </span></span>
<span><span class="co">##    minimum at  right endpoint  lambda  =  0.06203537 (eff. df= 126.3499 )</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Change names to match tempT and save</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">oxygenSmooth</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">oxygen</span><span class="op">)</span></span>
<span><span class="va">oxygenSmooth</span> <span class="op">&lt;-</span> <span class="va">oxygenSmooth</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oneRasterPlot.html">oneRasterPlot</a></span><span class="op">(</span><span class="va">oxygen</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, land <span class="op">=</span> <span class="va">land</span>, landCol <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>              title<span class="op">=</span> <span class="st">"Surface Apparent Oxygen Utilization\n(µmol/kg), interpolated"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oneRasterPlot.html">oneRasterPlot</a></span><span class="op">(</span><span class="va">oxygenSmooth</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, land <span class="op">=</span> <span class="va">land</span>, landCol <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>     title <span class="op">=</span> <span class="st">"Surface Apparent Oxygen Utilization\n(µmol/kg), interpolated and smoothed"</span><span class="op">)</span></span></code></pre></div>
<p><img src="b_RasterProcessing_files/figure-html/smoothing%20oxygen-1.png"><!-- --></p>
</div>
<div class="section level2">
<h2 id="tidying-up">Tidying up<a class="anchor" aria-label="anchor" href="#tidying-up"></a>
</h2>
<p>Last, we need to close the temporary directory we opened when we
opened the data.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">td</span>, recursive <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Collins WD, Bitz CM, Blackmon ML, Bonan GB, Bretherton CS, Carton JA,
Chang P, Doney SC, Hack JJ, Henderson TB, Kiehl JT, Large WG, McKenna
DS, Santer BD, Smith RD. (2006) The Community Climate System Model
Version 3 (CCSM3) Journal of Climate, 19(11), 2122–2143 DOI:
10.1175/jcli3761.1</p>
<p>Garcia HE, Boyer P, Baranova OK, Locarnini RA, Mishonov AV, Grodsky
A, Paver CR, Weathers KW, Smolyar IV, Reagan JR, Seidov D, Zweng MM.
(2018a). World Ocean Atlas 2018 (A. Mishonov, Ed.). NOAA National
Centers for Environmental Information. <a href="https://accession.nodc.noaa.gov/NCEI-WOA18" class="external-link uri">https://accession.nodc.noaa.gov/NCEI-WOA18</a></p>
<p>Garcia HE, Weathers K, Paver CR, Smolyar I, Boyer TP, Locarnini RA,
Zweng MM, Mishonov AV, Baranova OK, Seidov D, Reagan JR (2018b). World
Ocean Atlas 2018, Volume 3: Dissolved Oxygen, Apparent Oxygen
Utilization, and Oxygen Saturation. A Mishonov Technical Ed.; NOAA Atlas
NESDIS 83, 38pp.</p>
<p>Locarnini RA, Mishonov AV, Baranova OK, Boyer TP, Zweng MM, Garcia
HE, Reagan JR, Seidov D, Weathers K, Paver CR, Smolyar I (2018). World
Ocean Atlas 2018, Volume 1: Temperature. A. Mishonov Technical Ed.; NOAA
Atlas NESDIS 81, 52pp.</p>
<p>Nychka D, Furrer R, Paige J, Sain S (2021). “fields: Tools for
spatial data.” R package version 13.3, &lt;URL: <a href="https://github.com/dnychka/fieldsRPackage" class="external-link uri">https://github.com/dnychka/fieldsRPackage</a>&gt;.</p>
<p>R Core Team (2017). R: A language and environment for statistical
computing. R Foundation for Statistical Computing, Vienna, Austria. URL
<a href="https://www.R-project.org/" class="external-link uri">https://www.R-project.org/</a>.</p>
<p>Valdes PJ, Armstrong E, Badger MPS, Bradshaw CD, Bragg F, Crucifix M,
Davies-Barnard T, Day JJ, Farnsworth A, Gordon C, Hopcroft PO, Kennedy
AT, Lord NS, Lunt DJ, Marzocchi A, Parry LM, Pope V, Roberts WHG, Stone
EJ, … Williams JHT. (2017). The BRIDGE HadCM3 family of climate models:
<a href="mailto:HadCM3@Bristol" class="email">HadCM3@Bristol</a> v1.0.
Geoscientific Model Development, 10(10), 3715–3743. DOI:
10.5194/gmd-10-3715-2017</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Hannah L. Owens, Emmaline Sheahan, Carsten Rahbek.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
